#!/bin/bash

# Comprehensive Droplet Diagnostic Script
echo "üîç Diagnosing Secret Chat deployment issues..."
echo "================================================="

# Basic info
echo "üìç Current location: $(pwd)"
echo "üë§ Current user: $(whoami)"
echo "üïê Current time: $(date)"
echo ""

# Check if we're in the right place
echo "üìÅ Directory structure check:"
if [ -d "/var/www/secret-chat" ]; then
    echo "‚úÖ /var/www/secret-chat exists"
    cd /var/www/secret-chat
    echo "üìÇ Contents of /var/www/secret-chat:"
    ls -la
    echo ""
else
    echo "‚ùå /var/www/secret-chat not found!"
    echo "üîç Searching for secret-chat directories..."
    find / -name "*secret-chat*" -type d 2>/dev/null
    exit 1
fi

# Check essential files
echo "üìã Essential files check:"
files=("package.json" "server.js" ".env" "public/index.html" "public/script.js" "public/styles.css")
for file in "${files[@]}"; do
    if [ -f "$file" ]; then
        echo "‚úÖ $file exists ($(stat -c%s "$file") bytes)"
    else
        echo "‚ùå $file MISSING!"
    fi
done
echo ""

# Check public directory specifically
echo "üìÇ Public directory contents:"
if [ -d "public" ]; then
    ls -la public/
    echo ""
    echo "üìÑ File sizes in public:"
    du -h public/*
else
    echo "‚ùå Public directory missing!"
fi
echo ""

# Check Node.js and npm
echo "üîß System tools:"
echo "Node.js: $(node --version 2>/dev/null || echo 'NOT INSTALLED')"
echo "NPM: $(npm --version 2>/dev/null || echo 'NOT INSTALLED')"
echo "PM2: $(pm2 --version 2>/dev/null || echo 'NOT INSTALLED')"
echo ""

# Check PM2 processes
echo "üìä PM2 processes:"
pm2 list 2>/dev/null || echo "PM2 not running or no processes"
echo ""

# Check what's running on port 3000
echo "üåê Port 3000 status:"
netstat -tulpn 2>/dev/null | grep :3000 || echo "Nothing on port 3000"
echo ""

# Check recent PM2 logs
echo "üìù Recent PM2 logs (last 20 lines):"
pm2 logs secret-chat --lines 20 2>/dev/null || echo "No PM2 logs for secret-chat"
echo ""

# Test file serving manually
echo "üß™ Testing file access:"
if [ -f "public/index.html" ]; then
    echo "üìÑ index.html first 3 lines:"
    head -3 public/index.html
    echo ""
    echo "üìÑ index.html mentions of CSS/JS:"
    grep -n "\.css\|\.js" public/index.html || echo "No CSS/JS references found"
fi
echo ""

# Check environment
echo "‚öôÔ∏è Environment check:"
if [ -f ".env" ]; then
    echo "üìÑ .env contents:"
    cat .env
else
    echo "‚ùå .env file missing!"
fi
echo ""

# Check git status
echo "üîÑ Git status:"
git status 2>/dev/null || echo "Not a git repository"
echo ""

# Process check
echo "üîç Node processes:"
ps aux | grep node | grep -v grep || echo "No node processes running"
echo ""

echo "================================================="
echo "üîß RECOMMENDED FIXES:"
echo "1. cd /var/www/secret-chat"
echo "2. pm2 stop secret-chat"
echo "3. pm2 start server.js --name secret-chat"
echo "4. pm2 logs secret-chat"
echo "5. curl http://localhost:3000"
echo "================================================="
